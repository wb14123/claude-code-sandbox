name: Check Dependencies

on:
  schedule:
    # Run daily at noon Eastern Time (17:00 UTC = 12:00 PM EST / 1:00 PM EDT)
    - cron: '0 17 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for updates
        id: check
        run: |
          echo "Checking for dependency updates..."

          # Initialize variables
          UPDATES_FOUND=false
          UPDATE_MESSAGE=""
          CHECK_FAILED=false
          ERROR_MESSAGE=""

          # 1. Check Node.js base image version
          echo "## Checking Node.js base image..."
          CURRENT_NODE_VERSION="25"

          # Get available Node.js versions from Docker Hub
          NODE_TAGS=$(curl -s "https://registry.hub.docker.com/v2/repositories/library/node/tags?page_size=100&name=bookworm" | \
            jq -r '.results[].name' | \
            grep -E '^[0-9]+-bookworm$' | \
            sed 's/-bookworm$//' | \
            sort -V)

          LATEST_NODE_VERSION=$(echo "$NODE_TAGS" | tail -n1)

          if [ -z "$LATEST_NODE_VERSION" ]; then
            echo "ERROR: Failed to fetch latest Node.js version from Docker Hub"
            CHECK_FAILED=true
            ERROR_MESSAGE="${ERROR_MESSAGE}Failed to fetch Node.js versions from Docker Hub\n"
          else
            echo "Current Node.js version: $CURRENT_NODE_VERSION"
            echo "Latest Node.js version: $LATEST_NODE_VERSION"

            if [ "$LATEST_NODE_VERSION" != "$CURRENT_NODE_VERSION" ]; then
              UPDATES_FOUND=true
              UPDATE_MESSAGE="${UPDATE_MESSAGE}### Node.js Base Image Update Available\n"
              UPDATE_MESSAGE="${UPDATE_MESSAGE}- Current: \`node:${CURRENT_NODE_VERSION}-bookworm\`\n"
              UPDATE_MESSAGE="${UPDATE_MESSAGE}- Latest: \`node:${LATEST_NODE_VERSION}-bookworm\`\n\n"
            fi
          fi

          # 2. Check Claude Code npm package version
          echo "## Checking Claude Code npm package..."
          LATEST_CLAUDE_CODE=$(npm view @anthropic-ai/claude-code version 2>&1)

          if [ $? -ne 0 ] || [ -z "$LATEST_CLAUDE_CODE" ]; then
            echo "ERROR: Failed to fetch latest Claude Code version from npm"
            CHECK_FAILED=true
            ERROR_MESSAGE="${ERROR_MESSAGE}Failed to fetch Claude Code version from npm\n"
          else
            echo "Latest Claude Code version on npm: $LATEST_CLAUDE_CODE"
          fi

          # 3. Check version in published Docker image
          echo "## Checking published Docker image..."

          # Pull the published image
          if ! docker pull wb14123/claude-code:latest; then
            echo "ERROR: Failed to pull Docker image wb14123/claude-code:latest"
            CHECK_FAILED=true
            ERROR_MESSAGE="${ERROR_MESSAGE}Failed to pull Docker image wb14123/claude-code:latest\n"
          else
            # Get the Claude Code version from the published image
            # Format is: "2.0.70 (Claude Code)"
            PUBLISHED_CLAUDE_CODE=$(docker run --rm wb14123/claude-code:latest claude --version 2>&1 | grep -oP '^[0-9.]+' || echo "")

            if [ -z "$PUBLISHED_CLAUDE_CODE" ]; then
              echo "ERROR: Failed to extract Claude Code version from published image"
              echo "Raw output from docker run:"
              docker run --rm wb14123/claude-code:latest claude --version 2>&1
              CHECK_FAILED=true
              ERROR_MESSAGE="${ERROR_MESSAGE}Failed to extract Claude Code version from published Docker image\n"
            else
              echo "Claude Code version in published image: $PUBLISHED_CLAUDE_CODE"

              # Compare versions only if we have both versions
              if [ -n "$LATEST_CLAUDE_CODE" ]; then
                if [ "$PUBLISHED_CLAUDE_CODE" != "$LATEST_CLAUDE_CODE" ]; then
                  UPDATES_FOUND=true
                  UPDATE_MESSAGE="${UPDATE_MESSAGE}### Claude Code Update Available\n"
                  UPDATE_MESSAGE="${UPDATE_MESSAGE}- Published image version: \`$PUBLISHED_CLAUDE_CODE\`\n"
                  UPDATE_MESSAGE="${UPDATE_MESSAGE}- Latest npm version: \`$LATEST_CLAUDE_CODE\`\n\n"
                fi
              fi
            fi
          fi

          # 4. Check Node.js image digest to detect base image updates
          echo "## Checking for base image updates (same version)..."
          CURRENT_NODE_DIGEST=$(docker pull node:${CURRENT_NODE_VERSION}-bookworm 2>&1 | grep -oP 'Digest: \K[a-z0-9:]+' || echo "")

          # Get the Node.js digest from our published image
          PUBLISHED_IMAGE_NODE_LAYER=$(docker inspect wb14123/claude-code:latest | jq -r '.[0].RootFS.Layers[0]' || echo "")

          if [ -n "$CURRENT_NODE_DIGEST" ]; then
            UPDATE_MESSAGE="${UPDATE_MESSAGE}### Base Image Information\n"
            UPDATE_MESSAGE="${UPDATE_MESSAGE}- Latest \`node:${CURRENT_NODE_VERSION}-bookworm\` digest: \`${CURRENT_NODE_DIGEST}\`\n"
            UPDATE_MESSAGE="${UPDATE_MESSAGE}- Consider rebuilding if this has changed\n\n"
          fi

          # Check if any checks failed
          if [ "$CHECK_FAILED" = true ]; then
            echo "ERROR: One or more dependency checks failed!"
            echo -e "\nErrors encountered:\n$ERROR_MESSAGE"
            echo "check_failed=true" >> $GITHUB_OUTPUT
            echo "error_message<<EOF" >> $GITHUB_OUTPUT
            echo -e "$ERROR_MESSAGE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Export results
          if [ "$UPDATES_FOUND" = true ]; then
            echo "updates_found=true" >> $GITHUB_OUTPUT
            echo "update_message<<EOF" >> $GITHUB_OUTPUT
            echo -e "$UPDATE_MESSAGE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "updates_found=false" >> $GITHUB_OUTPUT
            echo "No updates found. All dependencies are up to date!"
          fi

          # Always output version info for logging
          echo "current_node=${CURRENT_NODE_VERSION:-unknown}" >> $GITHUB_OUTPUT
          echo "latest_node=${LATEST_NODE_VERSION:-unknown}" >> $GITHUB_OUTPUT
          echo "latest_claude_code=${LATEST_CLAUDE_CODE:-unknown}" >> $GITHUB_OUTPUT
          echo "published_claude_code=${PUBLISHED_CLAUDE_CODE:-unknown}" >> $GITHUB_OUTPUT

      - name: Create or update issue
        if: steps.check.outputs.updates_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Dependency Updates Available';
            const body = `${{ steps.check.outputs.update_message }}

            ---

            **Action Items:**
            1. Review the updates above
            2. Update the \`Dockerfile\` if needed
            3. Build and test the new image
            4. Push the updated image to Docker Hub

            **Automated Check Details:**
            - Node.js: Current \`${{ steps.check.outputs.current_node }}\` → Latest \`${{ steps.check.outputs.latest_node }}\`
            - Claude Code: Published \`${{ steps.check.outputs.published_claude_code }}\` → Latest \`${{ steps.check.outputs.latest_claude_code }}\`

            This issue was automatically created by the dependency check workflow.`;

            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['dependencies', 'automated']
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dependencies', 'automated']
              });
              console.log(`Created new issue #${newIssue.data.number}`);
            }

      - name: Close issue if no updates
        if: steps.check.outputs.updates_found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Dependency Updates Available';

            // Check if an issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['dependencies', 'automated']
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (existingIssue) {
              // Close the issue with a comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: 'All dependencies are now up to date. Closing this issue automatically.'
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                state: 'closed'
              });
              console.log(`Closed issue #${existingIssue.number}`);
            } else {
              console.log('No open dependency issues found.');
            }
