name: Check Dependencies

on:
  schedule:
    # Run daily at noon Eastern Time (17:00 UTC = 12:00 PM EST / 1:00 PM EDT)
    - cron: '0 17 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for updates
        id: check
        run: ./claude-code/check-dependencies.sh

      - name: Create or update issue
        if: steps.check.outputs.updates_found == 'true'
        uses: actions/github-script@v7
        env:
          UPDATE_MESSAGE: ${{ steps.check.outputs.update_message }}
          CURRENT_NODE: ${{ steps.check.outputs.current_node }}
          LATEST_NODE: ${{ steps.check.outputs.latest_node }}
          PUBLISHED_CLAUDE: ${{ steps.check.outputs.published_claude_code }}
          LATEST_CLAUDE: ${{ steps.check.outputs.latest_claude_code }}
        with:
          script: |
            const title = 'Dependency Updates Available';
            const body = `${process.env.UPDATE_MESSAGE}

            ---

            **Action Items:**
            1. Review the updates above
            2. Update the \`Dockerfile\` if needed
            3. Build and test the new image
            4. Push the updated image to Docker Hub

            **Automated Check Details:**
            - Node.js: Current \`${process.env.CURRENT_NODE}\` → Latest \`${process.env.LATEST_NODE}\`
            - Claude Code: Published \`${process.env.PUBLISHED_CLAUDE}\` → Latest \`${process.env.LATEST_CLAUDE}\`

            This issue was automatically created by the dependency check workflow.`;

            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['dependencies', 'automated']
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dependencies', 'automated']
              });
              console.log(`Created new issue #${newIssue.data.number}`);
            }

      - name: Close issue if no updates
        if: steps.check.outputs.updates_found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Dependency Updates Available';

            // Check if an issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['dependencies', 'automated']
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (existingIssue) {
              // Close the issue with a comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: 'All dependencies are now up to date. Closing this issue automatically.'
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                state: 'closed'
              });
              console.log(`Closed issue #${existingIssue.number}`);
            } else {
              console.log('No open dependency issues found.');
            }
